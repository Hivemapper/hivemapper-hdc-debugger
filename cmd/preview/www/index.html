<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Preview</title>
    <style>
        .kv{
            display: flex;
            padding-right: 5px;
            padding-left: 5px;
        }
        .value {
            text-align: right;
        }
        label {
            padding-right: 5px;
            flex: 1;
        }
    </style>
    <script src="https://jspm.dev/@spectrum-web-components/bundle/elements.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://opensource.adobe.com/spectrum-web-components/styles.css">
    <link rel="preload" href="https://opensource.adobe.com/spectrum-web-components/styles.css" as="style">
</head>
<script>
    let currentImage = "";
    dashcameServer = ""

    let ctx
    let chart

    Chart.defaults.backgroundColor = '#9BD0F5';
    Chart.defaults.borderColor = 'rgb(102, 37, 0)';
    Chart.defaults.color = 'white';

    function refreshData() {
        if (!ctx) {
            ctx = document.getElementById('myChart');
            chart = new Chart(ctx, {
                type: 'line',
                color: 'red',
                data: {
                    datasets: [
                        {
                            label: 'hdop',
                            borderWidth: 1,
                        },
                        {
                            label: 'pdop',
                            borderWidth: 1
                        },
                        {
                            label: 'sat_used',
                            borderWidth: 1
                        }]
                },
                options: {
                    scales: {
                        x: {},
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        fetch(`${dashcameServer}/lastframe`)
            .then((response) => response.json())
            .then(function (data) {
                currentImage = data.Filename;
                document.getElementById("image-path").innerHTML = currentImage;
                document.getElementById("image-size").innerHTML = Math.trunc(data.Size / 1024) + "KB";
                document.getElementById("my-image").src = "/framejpg/" + currentImage;
            }).catch(function (e) {
            // console.log(e)
        });
        fetch(`${dashcameServer}/top`)
            .then((response) => response.json())
            .then(function (data) {
                const mem = data.Memory
                const cpu = data.CPU
                const frame = data.FrameStats
                document.getElementById("memory_total").innerHTML = mem.Total;
                document.getElementById("memory_used").innerHTML = mem.Used;
                document.getElementById("memory_free").innerHTML = mem.Free;
                document.getElementById("memory_active").innerHTML = mem.Active;
                document.getElementById("memory_cache").innerHTML = mem.Cached;
                document.getElementById("memory_swap").innerHTML = mem.SwapTotal;

                document.getElementById("cpu_total").innerHTML = cpu.Total.toFixed(0) + " %";
                document.getElementById("cpu_used").innerHTML = (cpu.Total - cpu.Idle).toFixed(0) + " %";
                document.getElementById("cpu_user").innerHTML = cpu.User.toFixed(0) + " %";
                document.getElementById("cpu_system").innerHTML = cpu.System.toFixed(0) + " %";
                document.getElementById("cpu_idle").innerHTML = cpu.Idle.toFixed(0) + " %";

                document.getElementById("frame_rate").innerHTML = frame.Framerate;
                document.getElementById("frame_average_size").innerHTML = Math.trunc(frame.FrameAverageSize / 1024) + "KB";
                document.getElementById("frame_total").innerHTML = frame.FrameTotalCount;

            }).catch(function (e) {
            console.log(e)
        });

        fetch(`${dashcameServer}/gps`)
            .then((response) => response.json())
            .then(function (rawData) {
                const labels = [];
                rawData.gdop.forEach(function (item, index) {
                    const d = new Date(item.Ts);
                    labels.push(d.toLocaleTimeString('en-CA', {hour12: false}));
                });
                chart.data.datasets.forEach((dataset, index) => {
                    const data = ToData(dataset.label, rawData);
                    chart.data.datasets[index].data = data;
                });
                chart.data.labels = labels;
                chart.update();
            }).catch(function (e) {
            console.log(e)
        });
    }

    function ToData(label, rawData) {
        const selectedData = rawData[label];
        const selectedDataValues = [];
        selectedData.forEach(function (item, index) {
            selectedDataValues.push(item.Value);
        });

        return selectedDataValues;
    }

    function copyImage() {
        fetch(`${dashcameServer}/copy/${currentImage}`).then(async (response) => {
            if (response.ok) {
            } else {
                alert("Error grabbing image:" + response.status + " " + await response.text());
            }
        }).catch(function (e) {
            alert(e);
        });
    }

    function applyCameraConfig() {
        const camConfigItems = document.getElementsByClassName("cam-config");
        const config = {};
        for (let item of camConfigItems) {
            console.log(item.id, item.value);
            config[item.id] = item.value;
        }

        let opts = {
            method: 'POST',
            body: JSON.stringify(config),
        }
        fetch(`${dashcameServer}/camera/restart`, opts).catch(function (e) {
            alert(e);
        });
    }
</script>
<body onload="refreshData()">
<script>
    const intervalId = window.setInterval(function () {
        refreshData()
    }, 1000);
</script>

<sp-theme scale="large" color="dark">
    <sp-split-view>
        <div style="width: 25%">
            <div style="display: flex; padding:5px;">
                <h3 id="image-path" style="flex: 1">Image name here</h3>
                <h4 id="image-size">Size here</h4>
            </div>
            <h2 style="margin-top: 20px; background-color: var(--spectrum-global-color-gray-75)"
                class="spectrum-Heading spectrum-Heading--sizeS">GPS Health</h2>
            <div style="display: flex; padding: 5px;">
                <canvas id="myChart"></canvas>
            </div>
            <sp-divider size="m"></sp-divider>

            <h2 style="margin-top: 20px; background-color: var(--spectrum-global-color-gray-75)"
                class="spectrum-Heading spectrum-Heading--sizeS">Frames</h2>
            <div style="display: flex; padding:5px">
                <div style="flex: 2">
                    <label>Rate:</label>
                    <span class="value" id="frame_rate">--</span>
                </div>
                <div style="flex: 2">
                    <label>Average size:</label>
                    <span class="value" id="frame_average_size">--</span>
                </div>
                <div style="flex: 2">
                    <label>Total count:</label>
                    <span class="value" id="frame_total">--</span>
                </div>
            </div>
            <sp-divider size="m"></sp-divider>
            <h2 style="margin-top: 20px; background-color: var(--spectrum-global-color-gray-75)"
                class="spectrum-Heading spectrum-Heading--sizeS">Top</h2>
            <sp-split-view>
                <div>
                    <sp-split-view vertical>
                        <label style="height: 30px">CPU</label>
                        <div>
                            <div class="kv">
                                <label >Total:</label>
                                <span class="value" id="cpu_total"></span>
                            </div>
                            <div class="kv">
                                <label>Used:</label>
                                <span class="value" id="cpu_used"></span>
                            </div>
                            <div class="kv">
                                <label>User:</label>
                                <span class="value" id="cpu_user"></span>
                            </div>
                            <div class="kv">
                                <label>System:</label>
                                <span class="value" id="cpu_system"></span>
                            </div>
                            <div class="kv">
                                <label>Idle:</label>
                                <span class="value" id="cpu_idle"></span>
                            </div>
                        </div>
                    </sp-split-view>
                </div>
                <div>
                    <sp-split-view vertical>
                        <label style="height: 30px">Memory</label>
                        <div>
                            <div class="kv">
                                <label>Total:</label>
                                <span class="value" id="memory_total"></span>
                            </div>
                            <div class="kv">
                                <label>Used:</label>
                                <span class="value" id="memory_used"></span>
                            </div>
                            <div class="kv">
                                <label>Free:</label>
                                <span class="value" id="memory_free"></span>
                            </div>
                            <div class="kv">
                                <label>Active:</label>
                                <span class="value" id="memory_active">--</span>
                            </div>
                            <div class="kv">
                                <label>Cache:</label>
                                <span class="value" id="memory_cache">--</span>
                            </div>
                            <div class="kv">
                                <label>Swap:</label>
                                <span class="value" id="memory_swap">--</span>
                            </div>
                        </div>
                    </sp-split-view>
                </div>
            </sp-split-view>

            <sp-divider size="m "></sp-divider>
            <h2 style="margin-top: 20px; background-color: var(--spectrum-global-color-gray-75)"
                class="spectrum-Heading spectrum-Heading--sizeS">Camera config</h2>
            <div style="margin-top: 20px">
                <sp-button onclick="myFunction()">Refresh</sp-button>
                <sp-button onclick="copyImage()">Grab</sp-button>
                <sp-button onclick="applyCameraConfig()">Apply Restart</sp-button>
            </div>

            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Shutter:</label>
                </div>
                <sp-textfield class="cam-config" id="shutter" value="0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Metering:</label>
                </div>
                <sp-textfield class="cam-config" id="analoggain" value="0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Analog Gain:</label>
                </div>
                <sp-picker class="cam-config" id="metering" value="centre">
                    <sp-menu-item value="centre">centre</sp-menu-item>
                    <sp-menu-item value="spot">spot</sp-menu-item>
                    <sp-menu-item value="average">average</sp-menu-item>
                    <sp-menu-item value="custom">custom</sp-menu-item>
                </sp-picker>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Exposure:</label>
                </div>
                <sp-picker class="cam-config" id="exposure" value="normal">
                    <sp-menu-item value="normal">normal</sp-menu-item>
                    <sp-menu-item value="sport">sport</sp-menu-item>
                </sp-picker>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Ev (exposure compensation):</label>
                </div>
                <sp-textfield class="cam-config" id="ev" value="0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>AWB:</label>
                </div>
                <sp-picker class="cam-config" id="awb" value="auto">
                    <sp-menu-item value="auto">auto</sp-menu-item>
                    <sp-menu-item value="incandescent">incandescent</sp-menu-item>
                    <sp-menu-item value="tungsten">tungsten</sp-menu-item>
                    <sp-menu-item value="fluorescent">fluorescent</sp-menu-item>
                    <sp-menu-item value="indoor">indoor</sp-menu-item>
                    <sp-menu-item value="daylight">daylight</sp-menu-item>
                    <sp-menu-item value="cloudy">cloudy</sp-menu-item>
                    <sp-menu-item value="custom">custom</sp-menu-item>
                </sp-picker>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Awb gains:</label>
                </div>
                <sp-textfield class="cam-config" id="awbgains" value="0.0,0.0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Brightness (-1.0 to 1.0):</label>
                </div>
                <sp-textfield class="cam-config" id="brightness" value="0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Contrast:<br/>where 1.0 = normal contrast</label>
                </div>
                <sp-textfield class="cam-config" id="contrast" value="1.0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Saturation:<br/>where 1.0 = normal and 0.0 = greyscale</label>
                </div>
                <sp-textfield class="cam-config" id="saturation" value="1.0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Sharpness:<br/>where 1.0 = normal sharpening</label>
                </div>
                <sp-textfield class="cam-config" id="sharpness" value="1.0"></sp-textfield>
            </div>
            <div style="display: flex">
                <div style="display: flex; flex:1; align-items: center;">
                    <label>Denoise:</label>
                </div>
                <sp-picker class="cam-config" id="denoise" value="auto">
                    <sp-menu-item value="auto">auto</sp-menu-item>
                    <sp-menu-item value="off">off</sp-menu-item>
                    <sp-menu-item value="cdn_off">cdn_off</sp-menu-item>
                    <sp-menu-item value="cdn_fast">cdn_fast</sp-menu-item>
                    <sp-menu-item value="cdn_hq">cdn_hq</sp-menu-item>
                </sp-picker>
            </div>
        </div>
        <div style="width: 75%; height: 100%">
            <img id="my-image" width="100%" alt="image" src=""/>
        </div>
    </sp-split-view>
</sp-theme>
</body>
</html>

